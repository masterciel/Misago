{% extends "sora/layout.html" %}
{% load i18n %}
{% load url from future %}
{% import "sora/editor.html" as editor with context %}
{% import "sora/macros.html" as macros with context %}

{% block title %}{{ macros.page_title(title=thread.name,parent=forum.name,page=pagination['page']) }}{% endblock %}

{% block breadcrumb %}{{ super() }} <span class="divider">/</span></li>
{% for parent in parents %}
<li class="first"><a href="{{ parent.type|url(forum=forum.pk, slug=forum.slug) }}">{{ parent.name }}</a> <span class="divider">/</span></li>
{% endfor %}
<li class="active">{{ thread.name }}
{%- endblock %}

{% block content %}
<div class="page-header">
  <ul class="breadcrumb">
    {{ self.breadcrumb() }}</li>
  </ul>
  <h1>{{ thread.name }}</h1>
  <ul class="unstyled thread-info">
    <li><i class="icon-time"></i> {{ thread.last|reltimesince }}</li>
    <li><i class="icon-user"></i> {% if thread.start_poster %}<a href="{% url 'user' user=thread.start_poster_id, username=thread.start_poster_slug %}">{{ thread.start_poster_name }}</a>{% else %}{{ thread.start_poster_name }}{% endif %}</li>
    <li><i class="icon-comment"></i> {% if thread.replies > 0 -%}
      {% trans count=thread.replies, replies=thread.replies|intcomma %}One reply{% pluralize %}{{ replies }} replies{% endtrans %}
    {%- else -%}
      {% trans %}No replies{% endtrans %}
    {%- endif %}</li>
  </ul>
</div>
{% if message %}{{ macros.draw_message(message) }}{% endif %}
<div class="list-nav">
  {{ pager() }}
  {% if user.is_authenticated() %}
  <ul class="nav nav-pills pull-right">
    <li class="info"><a href="{% url 'thread_new' forum=forum.pk, slug=forum.slug %}"><i class="icon-ok"></i> {% trans %}Watch Thread{% endtrans %}</a></li>{% if acl.threads.can_reply(thread) %}
    <li class="primary"><a href="{% url 'thread_new' forum=forum.pk, slug=forum.slug %}"><i class="icon-plus"></i> {% trans %}Reply{% endtrans %}</a></li>{% endif %}
  </ul>
  {% endif %}
</div>

<div class="posts-list">
  {% for post in posts %}
  <div id="post-{{ post.pk }}" class="well well-post{% if post.user and post.user.rank and post.user.rank.style %} {{ post.user.rank.style }}{% endif %}">
    <div class="post-author">
      <img src="{{ post.user.get_avatar() }}" alt="" class="avatar-normal">
      <div class="post-bit">
        <a href="{% url 'user' user=post.user.pk, username=post.user.username_slug %}" class="lead">{{ post.user.username }}</a>{% if post.user.get_title() %}
        <p class="user-title">{{ _(post.user.get_title()) }}</p>{% endif %}
        <p class="post-date">{{ post.date|reltimesince|low }}</p>
      </div>
    </div>
    <div class="post-content">
      <div class="markdown">
        {{ post.post_preparsed|safe }}
      </div>
      {% if post.user.signature %}
      <div class="post-foot">
        {# <p class='lead'><a href="{% url 'user' user=post.user.pk, username=post.user.username_slug %}" class="lead">{{ post.user.username }}</a>, {{ post.date|reltimesince|low }}</p> #}
        {% if post.user.signature %}
        <div class="signature">
          <div class="markdown">
            {{ post.user.signature_preparsed|safe }}
          </div>
        </div>
        {% endif %}
      </div>
      {% endif %}
    </div>
  </div>
  {% endfor %}
</div>

<div class="list-nav last">
  {{ pager() }}
  {% if user.is_authenticated() and acl.threads.can_reply(thread) %}
  <ul class="nav nav-pills pull-right">
    <li class="primary"><a href="{% url 'thread_new' forum=forum.pk, slug=forum.slug %}"><i class="icon-plus"></i> {% trans %}Reply{% endtrans %}</a></li>
  </ul>
  {% endif %}
</div>

{% if user.is_authenticated() and acl.threads.can_reply(thread) %}
<div class="quick-reply">
  <form action="{% url 'thread_reply' thread=thread.pk, slug=thread.slug %}" method="post">
    <input type="hidden" name="{{ csrf_id }}" value="{{ csrf_token }}">
    <input type="hidden" name="quick_reply" value="1">
    <img src="{{ user.get_avatar(big) }}" alt="{% trans %}Your Avatar{% endtrans %}" class="avatar-big">
    <div class="arrow"></div>
    {{ editor.editor(quick_reply.post, _('Post Reply')) }}
  </form>
</div>
{% endif %}
{% endblock %}

{% macro pager() %}
  <ul class="pager pull-left">
    {%- if pagination['prev'] > 1 %}<li><a href="{% url 'forum' slug=forum.slug, forum=forum.id %}" class="tooltip-top" title="{% trans %}First Page{% endtrans %}"><i class="icon-chevron-left"></i> {% trans %}First{% endtrans %}</a></li>{% endif -%}
    {%- if pagination['prev'] > 0 %}<li><a href="{%- if pagination['prev'] > 1 %}{% url 'forum' slug=forum.slug, forum=forum.id, page=pagination['prev'] %}{% else %}{% url 'forum' slug=forum.slug, forum=forum.id %}{% endif %}" class="tooltip-top" title="{% trans %}Newest Threads{% endtrans %}"><i class="icon-chevron-left"></i></a></li>{% endif -%}
    {%- if pagination['next'] > 0 %}<li><a href="{% url 'forum' slug=forum.slug, forum=forum.id, page=pagination['next'] %}" class="tooltip-top" title="{% trans %}Older Threads{% endtrans %}"><i class="icon-chevron-right"></i></a></li>{% endif -%}
    <li class="count">
    {%- trans current_page=pagination['page'], pages=pagination['total'] -%}
    Page {{ current_page }} of {{ pages }}
    {%- endtrans -%}
    </li>
  </ul>
{% endmacro %}
